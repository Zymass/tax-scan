datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                    String      @id @default(cuid())
  email                 String      @unique
  password_hash         String?     // Optional for OAuth users
  name                  String
  phone                 String?
  email_verified        Boolean     @default(false)
  email_verified_at     DateTime?
  google_id             String?     @unique // Google OAuth ID
  auth_provider         String      @default("email") // email, google
  calculations_limit    Int         @default(5) // Количество доступных расчетов
  
  calculations          Calculation[]
  
  created_at            DateTime    @default(now())
  updated_at            DateTime    @updatedAt
  deleted_at            DateTime?
}

model Calculation {
  id                    String      @id @default(cuid())
  user_id               String
  user                  User        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  status_type           String      // ИП, ООО, Самозанятый
  tax_regime            String      // УСН 6%, УСН 15%, ОСНО, Патент, НПД
  revenue_2025          Float
  region_code           String?
  
  total_tax_2025        Float       @default(0)
  total_tax_2026        Float       @default(0)
  total_tax_2027        Float       @default(0)
  total_tax_2028        Float       @default(0)
  
  recommended_regime    String?
  recommended_savings   Float       @default(0)
  
  status                String      @default("in_progress") // in_progress, completed, archived
  current_step          Int         @default(1)
  
  steps                 CalculationStep[]
  actions               ActionPlan[]
  scenarios             Scenario[]
  
  created_at            DateTime    @default(now())
  updated_at            DateTime    @updatedAt
  deleted_at            DateTime?
  
  @@index([user_id])
  @@index([created_at])
}

model CalculationStep {
  id                    String      @id @default(cuid())
  calculation_id        String
  calculation           Calculation @relation(fields: [calculation_id], references: [id], onDelete: Cascade)
  
  step_number           Int
  data                  String      @default("{}")
  
  completed_at          DateTime?
  
  created_at            DateTime    @default(now())
  updated_at            DateTime    @updatedAt
  
  @@unique([calculation_id, step_number])
  @@index([calculation_id])
}

model ActionPlan {
  id                    String      @id @default(cuid())
  calculation_id        String
  calculation           Calculation @relation(fields: [calculation_id], references: [id], onDelete: Cascade)
  
  action_code           String
  action_name           String
  description           String?
  
  due_date              DateTime
  completed             Boolean     @default(false)
  completed_at          DateTime?
  
  importance            String      // critical, high, medium, low
  category              String      // Q1, Q2, Q3, Q4, ongoing
  
  created_at            DateTime    @default(now())
  updated_at            DateTime    @updatedAt
  
  @@index([calculation_id])
  @@index([due_date])
}

model Scenario {
  id                    String      @id @default(cuid())
  calculation_id        String
  calculation           Calculation @relation(fields: [calculation_id], references: [id], onDelete: Cascade)
  
  scenario_name         String
  scenario_data         String      @default("{}")
  
  result_total_tax      Float       @default(0)
  result_delta          Float       @default(0)
  
  created_at            DateTime    @default(now())
  
  @@index([calculation_id])
}
